{
  "hash": "de3a819900ffc02c6e9c936efd979237",
  "result": {
    "markdown": "---\ntitle: \"Randomized controlled trials (RCTs)\"\n---\n\n\n\n\nThere's no video for this example, since the R code is fairly straightforward, and since [I talked about it in the lecture](https://www.youtube.com/watch?v=W0NyALrjLA4&list=PLS6tnpTr39sGJURMOwN9tf9MNDN4t0JMz) ([see the slides](/slides/07-slides.html#26)).\n\nIf you want to follow along with this example, you can download the data below:\n\n- [{{< fa table >}} `village_randomized.csv`](/files/data/generated_data/village_randomized.csv)\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)  # ggplot(), %>%, mutate(), and friends\nlibrary(ggdag)  # Make DAGs\nlibrary(scales)  # Format numbers with functions like comma(), percent(), and dollar()\nlibrary(broom)  # Convert models to data frames\nlibrary(patchwork)  # Combine ggplots into single composite plots\n\nset.seed(1234)   # Make all random draws reproducible\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvillage_randomized <- read_csv(\"data/village_randomized.csv\")\n```\n:::\n\n\n\n\n## Program details\n\nIn this hypothetical situation, an NGO is planning on launching a training program designed to boost incomes. Based on their experiences in running pilot programs in other countries, they've found that older, richer men tend to self-select into the training program. The NGO's evaluation consultant (you!) drew this causal model explaining the effect of the program on participant incomes, given the confounding caused by age, sex, and prior income:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nincome_dag <- dagify(post_income ~ program + age + sex + pre_income,\n                     program ~ age + sex + pre_income,\n                     exposure = \"program\",\n                     outcome = \"post_income\",\n                     labels = c(post_income = \"Post income\",\n                                program = \"Program\",\n                                age = \"Age\",\n                                sex = \"Sex\",\n                                pre_income = \"Pre income\"),\n                     coords = list(x = c(program = 1, post_income = 5, age = 2,\n                                         sex = 4, pre_income = 3),\n                                   y = c(program = 2, post_income = 2, age = 1,\n                                         sex = 1, pre_income = 3)))\n\nggdag_status(income_dag, use_labels = \"label\", text = FALSE, seed = 1234) +\n  guides(color = \"none\") +\n  theme_dag()\n```\n\n::: {.cell-output-display}\n![](rcts_files/figure-html/income-dag-1.png){fig-align='center' width=75%}\n:::\n:::\n\n\nThe NGO just received funding to run a randomized controlled trial (RCT) in a village, and you're excited because you can finally manipulate access to the program—you can calculate $E(\\text{Post-income} | do(\\text{Program})$. Following the rules of causal diagrams, you get to delete all the arrows going into the program node:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nincome_dag_rct <- dagify(post_income ~ program + age + sex + pre_income,\n                         exposure = \"program\",\n                         outcome = \"post_income\",\n                         labels = c(post_income = \"Post income\",\n                                    program = \"Program\",\n                                    age = \"Age\",\n                                    sex = \"Sex\",\n                                    pre_income = \"Pre income\"),\n                         coords = list(x = c(program = 1, post_income = 5, age = 2,\n                                             sex = 4, pre_income = 3),\n                                       y = c(program = 2, post_income = 2, age = 1,\n                                             sex = 1, pre_income = 3)))\n\nggdag_status(income_dag_rct, use_labels = \"label\", text = FALSE, seed = 1234) +\n  guides(color = \"none\") +\n  theme_dag()\n```\n\n::: {.cell-output-display}\n![](rcts_files/figure-html/income-dag-rct-1.png){fig-align='center' width=75%}\n:::\n:::\n\n\n\n## 1. Check balance\n\nYou ran the study on 1,000 participants over the course of 6 months and you just got your data back.\n\nBefore calculating the effect of the program, you first check to see how well balanced assignment was, and you find that assignment to the program was pretty much split 50/50, which is good:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvillage_randomized %>%\n  count(program) %>%\n  mutate(prop = n / sum(n))\n## # A tibble: 2 × 3\n##   program        n  prop\n##   <chr>      <int> <dbl>\n## 1 No program   503 0.503\n## 2 Program      497 0.497\n```\n:::\n\n\nYou then check to see how well balanced the treatment and control groups were in participants' pre-treatment characteristics:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvillage_randomized %>%\n  group_by(program) %>%\n  summarize(prop_male = mean(sex_num),\n            avg_age = mean(age),\n            avg_pre_income = mean(pre_income))\n## # A tibble: 2 × 4\n##   program    prop_male avg_age avg_pre_income\n##   <chr>          <dbl>   <dbl>          <dbl>\n## 1 No program     0.584    34.9           803.\n## 2 Program        0.604    34.9           801.\n```\n:::\n\n\nThese variables appear fairly well balanced. To check that there aren't any statistically significant differences between the groups, you make some graphs (you could run t-tests too, but graphs are easier for your non-statistical audience to read later).\n\nThere were more men in both the treatment and control groups, but the proportion is the same in both, and there's no substantial difference in sex proportion:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Here we save each plot as an object so that we can combine the two plots with\n# + (which comes from the patchwork package). If you want to see what an\n# individual plot looks like, you can run `plot_diff_sex`, or whatever the plot\n# object is named.\n#\n# stat_summary() here is a little different from the geom_*() layers you've seen\n# in the past. stat_summary() takes a function (here mean_se()) and runs it on\n# each of the program groups to get the average and standard error. It then\n# plots those with geom_pointrange. The fun.args part of this lets us pass an\n# argument to mean_se() so that we can multiply the standard error by 1.96,\n# giving us the 95% confidence interval.\nplot_diff_sex <- ggplot(village_randomized, aes(x = program, y = sex_num, color = program)) +\n  stat_summary(geom = \"pointrange\", fun.data = \"mean_se\", fun.args = list(mult = 1.96)) +\n  guides(color = \"none\") +\n  labs(x = NULL, y = \"Proportion male\")\n# plot_diff_sex  # Uncomment this if you want to see this plot by itself\n\nplot_prop_sex <- ggplot(village_randomized, aes(x = program, fill = sex)) +\n  # Using position = \"fill\" makes the bars range from 0-1 and show the proportion\n  geom_bar(position = \"fill\") +\n  labs(x = NULL, y = \"Proportion\", fill = NULL) +\n  scale_fill_manual(values = c(\"darkblue\", \"darkred\"))\n\n# Show the plots side-by-side\nplot_diff_sex + plot_prop_sex\n```\n\n::: {.cell-output-display}\n![](rcts_files/figure-html/balance-sex-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\nThe distribution of ages looks basically the same in the treatment and control groups, and there's no substantial difference in the average age across groups:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nplot_diff_age <- ggplot(village_randomized, aes(x = program, y = age, color = program)) +\n  stat_summary(geom = \"pointrange\", fun.data = \"mean_se\", fun.args = list(mult = 1.96)) +\n  guides(color = \"none\") +\n  labs(x = NULL, y = \"Age\")\n\nplot_hist_age <- ggplot(village_randomized, aes(x = age, fill = program)) +\n  geom_histogram(binwidth = 1, color = \"white\") +\n  guides(fill = \"none\") +\n  labs(x = \"Age\", y = \"Count\") +\n  facet_wrap(vars(program), ncol = 1)\n\nplot_diff_age + plot_hist_age\n```\n\n::: {.cell-output-display}\n![](rcts_files/figure-html/balance-age-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\nPre-program income is also distributed the same—and has no substantial difference in averages—across treatment and control groups:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nplot_diff_income <- ggplot(village_randomized, aes(x = program, y = pre_income, color = program)) +\n  stat_summary(geom = \"pointrange\", fun.data = \"mean_se\", fun.args = list(mult = 1.96)) +\n  guides(color = \"none\") +\n  labs(x = NULL, y = \"Pre income\")\n\nplot_hist_income <- ggplot(village_randomized, aes(x = pre_income, fill = program)) +\n  geom_histogram(binwidth = 20, color = \"white\") +\n  guides(fill = \"none\") +\n  labs(x = \"Pre income\", y = \"Count\") +\n  facet_wrap(vars(program), ncol = 1)\n\nplot_diff_income + plot_hist_income\n```\n\n::: {.cell-output-display}\n![](rcts_files/figure-html/balance-income-1.png){fig-align='center' width=100%}\n:::\n:::\n\n\nAll our pre-treatment covariates look good and balanced! You can now estimate the causal effect of the program.\n\n## 2. Estimate difference\n\nYou are interested in the causal effect of the program, or\n\n$$\nE[\\text{Post income}\\ |\\ do(\\text{Program})]\n$$\n\nYou can find this causal effect by calculating the average treatment effect:\n\n$$\n\\text{ATE} = E(\\overline{\\text{Post income }} | \\text{ Program} = 1) - E(\\overline{\\text{Post income }} | \\text{ Program} = 0)\n$$\n\nThis is simply the average outcome for people in the program minus the average outcome for people not in the program. You calculate the group averages:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nvillage_randomized %>%\n  group_by(program) %>%\n  summarize(avg_post = mean(post_income))\n## # A tibble: 2 × 2\n##   program    avg_post\n##   <chr>         <dbl>\n## 1 No program    1180.\n## 2 Program       1279.\n```\n:::\n\n\nThat's 1279 − 1180, or 99, which means that the program caused an increase of $99 in incomes, on average.\n\nFinding that difference required some manual math, so as a shortcut, you run a regression model with post-program income as the outcome variable and the program indicator variable as the explanatory variable. The coefficient for `program` is the causal effect (and it includes information about standard errors and significance). You find the same result:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmodel_rct <- lm(post_income ~ program, data = village_randomized)\ntidy(model_rct)\n## # A tibble: 2 × 5\n##   term           estimate std.error statistic  p.value\n##   <chr>             <dbl>     <dbl>     <dbl>    <dbl>\n## 1 (Intercept)      1180.       4.27     276.  0       \n## 2 programProgram     99.2      6.06      16.4 1.26e-53\n```\n:::\n\n\nBased on your RCT, you conclude that the program causes an average increase of $99.25 in income.\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nggplot(village_randomized, aes(x = program, y = post_income, color = program)) +\n  stat_summary(geom = \"pointrange\", fun.data = \"mean_se\", fun.args = list(mult = 1.96)) +\n  guides(color = \"none\") +\n  labs(x = NULL, y = \"Post income\")\n```\n\n::: {.cell-output-display}\n![](rcts_files/figure-html/rct-finding-1.png){fig-align='center' width=75%}\n:::\n:::\n",
    "supporting": [
      "rcts_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}