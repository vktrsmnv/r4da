{
  "hash": "deefb5b4ea634f6d3c10292d30641a14",
  "result": {
    "markdown": "---\ntitle: \"Potential outcomes, ATEs, and CATEs\"\n---\n\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nlibrary(tidyverse)     # ggplot, dplyr, and friends\nlibrary(broom)         # Convert models to data frames\nlibrary(scales)        # This makes it easy to format numbers with dollar(), comma(), etc.\nlibrary(ggdag)         # Draw causal diagrams with R\nlibrary(modelsummary)  # Fancy regression tables\n```\n:::\n\n\n## Theory\n\nAccording to the theory explained in chapter 2 of *Mastering 'Metrics*, attending a private university should be causally linked to earnings and income---that is, going to a private school should make you earn more money. The type of education you receive, however, is not the only factor that influences earnings. People self-select into different types of universities and choose where to apply and which offers to accept. They also choose to not apply to some schools and are also rejected from other schools. Unmeasured characteristics help determine both acceptance to schools and earnings.\n\nWe can draw a simplified version of this causal story with a directed acyclic graph (DAG) or causal model:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ndag <- dagify(Y ~ P + G,\n              P ~ G,\n              exposure = \"P\",\n              outcome = \"Y\",\n              labels = c(Y = \"Earnings\", P = \"Private university\",\n                         G = \"Student characteristics (group)\"),\n              coords = list(x = c(Y = 3, P = 1, G = 2),\n                            y = c(Y = 1, P = 1, G = 2)))\n\nggdag_status(dag, use_labels = \"label\") +\n  guides(color = \"none\") +  # Remove legend\n  theme_dag()\n```\n\n::: {.cell-output-display}\n![](po-ate-cate_files/figure-html/earnings-dag-1.png){fig-align='center' width=75%}\n:::\n:::\n\n\n## Effect of private school on earnings, no controls\n\nBecause we don't have a time machine, we can't look at individual-level counterfactuals---we can't send Person 1 to a private school, watch them for 40 years after, and then go back and send Person 1 to a public school and watch them for 40 years. To get around this, we can instead calculated the *average* treatment effect, or ATE, and find the average of all individual-level causal effects. We can use the information from our theory's DAG to calculate a (hopefully!) accurate ATE.\n\nFirst we load the data from this CSV file (typed from the table in *Mastering 'Metrics*):\n\n- [{{< fa table >}} `public_private_earnings.csv`](/files/data/external_data/public_private_earnings.csv)\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# The data doesn't come with an indicator variable marking if students went to a\n# private school, so we create one here. If the string \"ivy\" is found in the\n# enrolled column, mark it as true, otherwise mark it as false.\n#\n# We also create a variable that indicates if someone is in group A or not that\n# we'll use in the regression models. We could technically just include the\n# group variable in the model, where it would be treated as a dummy variable,\n# but the reference category would be A, not B, so this is a little trick to\n# force it to show results for group A.\nschools <- read_csv(\"data/public_private_earnings.csv\") %>%\n  mutate(private = ifelse(str_detect(enrolled, \"ivy\"), TRUE, FALSE)) %>%\n  mutate(group_A = ifelse(group == \"A\", TRUE, FALSE))\n\n# Only look at groups A and B, since C and D don't have people in both public\n# and private schools. | means \"or\"\nschools_small <- schools %>%\n  filter(group == \"A\" | group == \"B\")\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\nIt's really tempting to just find the average income for private school and subtract it from public school, like so:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nschools_small %>%\n  group_by(private) %>%\n  summarize(avg_earnings = mean(earnings))\n## # A tibble: 2 × 2\n##   private avg_earnings\n##   <lgl>          <dbl>\n## 1 FALSE          70000\n## 2 TRUE           90000\n```\n:::\n\n\nIt looks like those who went to private school have \\$20,000 more in earnings! That's a ton! It's also ***incredibly wrong***. ***Don't do this!*** This does not account for any confounding or selection bias. According to our DAG, student characteristics are a huge confounder. We need to account for those.\n\nFollowing the potential outcomes framework, we can find the ATE by combining the conditional ATEs (or CATEs) for subgroups that are likely to predict outcomes or that bunch up similar observations. Let's use the Group A and B distinction as our subgroups here.\n\nFirst we can look at the average income for people in each group, divided by whether they went to a private or public school:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\navg_earnings <- schools_small %>%\n  group_by(group, private) %>%\n  summarize(avg_earnings = mean(earnings))\n\navg_earnings\n## # A tibble: 4 × 3\n## # Groups:   group [2]\n##   group private avg_earnings\n##   <chr> <lgl>          <dbl>\n## 1 A     FALSE         110000\n## 2 A     TRUE          105000\n## 3 B     FALSE          30000\n## 4 B     TRUE           60000\n```\n:::\n\n\nHere we see that group A has higher income on average than group B, regardless of whether they went to a private school. Everyone in group A earns roughly \\$100,000, while those in group B earn a lot less.\n\nWe can find the exact differences in earnings for public vs. private within each group by pulling the values out of the table and taking their differences\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# Pulling out each of the numbers is tedious and a good example of why we use\n# regression instead. filter() selects rows that match the specified conditions\n# (here where group and private both equal something) and pull extracts a column\n# from the dataset. Because we're filtering this data in a way that makes it\n# only have one row, pull() will extract a single number.\n\n# Group A\nincome_private_A <- avg_earnings %>%\n  filter(group == \"A\" & private == TRUE) %>%\n  pull(avg_earnings)\n\nincome_public_A <- avg_earnings %>%\n  filter(group == \"A\" & private == FALSE) %>%\n  pull(avg_earnings)\n\ncate_a <- income_private_A - income_public_A\ncate_a\n## [1] -5000\n\n# Group B\nincome_private_B <- avg_earnings %>%\n  filter(group == \"B\" & private == TRUE) %>%\n  pull(avg_earnings)\n\nincome_public_B <- avg_earnings %>%\n  filter(group == \"B\" & private == FALSE) %>%\n  pull(avg_earnings)\n\ncate_b <- income_private_B - income_public_B\ncate_b\n## [1] 30000\n```\n:::\n\n\nThe private-public earnings gap for people in Group A (or $\\text{CATE}_\\text{Group A}$) is −\\\\\\$5,000, while for Group B (or $\\text{CATE}_\\text{Group B}$) it is \\\\\\$30,000. It seems that there's a big effect for Group B, but a small reversed effect for A.\n\nWe want to account for how many people are in each group, though, since A has more people than B, so we calculate the proportion of each group in the same and multiply the group differences by those proportions.\n\n$$\n\\text{ATE} = \\pi_\\text{Group A} \\text{CATE}_\\text{Group A} + \\pi_\\text{Group B} \\text{CATE}_\\text{Group B}\n$$\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\n# We need to find the proportion of people in each group\nprop_in_groups <- schools_small %>%\n  group_by(group) %>%\n  summarize(n = n()) %>%\n  mutate(prop = n / nrow(schools_small))\nprop_in_groups\n## # A tibble: 2 × 3\n##   group     n  prop\n##   <chr> <int> <dbl>\n## 1 A         3   0.6\n## 2 B         2   0.4\n\nprop_A <- prop_in_groups %>% filter(group == \"A\") %>% pull(prop)\nprop_B <- prop_in_groups %>% filter(group == \"B\") %>% pull(prop)\n\n# With those proportions, we can weight the differences in groups correctly\nweighted_effect <- (cate_a * prop_A) + (cate_b * prop_B)\nweighted_effect\n## [1] 9000\n```\n:::\n\n\nFrom this it looks like attending a private university causes a bump in earnings of $9,000. This is the average treatment effect (ATE).\n\n\n## Effect of private school on earnings, with regression and controls\n\nInstead of looking at weighted averages (since that's tedious with just two groups—imagine doing all that with 3+ groups!), we can use a regression model that accounts for differences between groups A and B, since something about group A made them way wealthier than group B regardless of school type.\n\nWe do that by predicting earnings based on private/public school attendance while also controlling for group:\n\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\nmodel_earnings <- lm(earnings ~ private + group_A, data = schools_small)\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n\n```{.r .cell-code}\ntidy(model_earnings)\n## # A tibble: 3 × 5\n##   term        estimate std.error statistic p.value\n##   <chr>          <dbl>     <dbl>     <dbl>   <dbl>\n## 1 (Intercept)   40000.    11952.     3.35   0.0789\n## 2 privateTRUE   10000.    13093.     0.764  0.525 \n## 3 group_ATRUE   60000     13093.     4.58   0.0445\n```\n:::\n\n\nThere are three important numbers here. The intercept (or $\\alpha$ in *Mastering 'Metrics*, or $\\beta_0$) is \\$40,000. This represents the earnings for someone with all the switches and sliders in the model set to 0 or turned off—in this case, someone who went to a public school in group B.\n\nThe `group_A` coefficient shows the effect of just being in that group. For whatever reason, Group A earns an average of \\$60,000 more than Group B—*for reasons other than education*. This allows us to control for the effect of selection.\n\nThe coefficient for `private` is the one we care about the most—this is the causal effect of private schools on earnings (assuming we can justify all the controls and the matching into groups). It is <span>\\$</span>10,000, which means that attending a private school gives you that much of a bump in income. This is larger than the <span>\\$</span>9,000 we found earlier, but is probably more accurate since we're accounting for other weighted differences between groups.\n",
    "supporting": [
      "po-ate-cate_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}